<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      th:lang-xmllang="en">

    <head>
        <div th:replace = "common/head :: head (title='Raw Analogue Events')"> </div>
        <script type = "text/javascript"
                src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    </head>

    <body>

        <section id="breadcrumbs">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">Raw Analogue Events</li>
            </ol>
        </section>

        <div th:replace = "common/header :: header (title='Raw Analogue Events')"> </div>


        <div class="container">
            <div class="row">
                <div class="col-md-12 col-lg-4">
                    <div>
                        <h1>Select parameters</h1>
                        <form id="form" action="#" action="/reports/raw-analogue-events/parameters" method="post">
                            <div class="form-group">
                                <label>Site:</label>
                                <select id="siteSelect" name="site">
                                    <option value="" selected="selected">--Select a Site--</option>
                                    <option th:each="site : ${sites}" th:value="${site.id}" th:text="${site.name}"></option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Channel:</label>
                                <select id="channelSelect" name="channel">
                                    <option value="" selected="selected"></option>
                                </select>
                            </div>
                            <div class = "row">
                                <div class="form-inline">
                                    <label>From:</label>
                                    <input id="fromSelect" type="date" value = "" name="from">
                                    <label>To:</label>
                                    <input  id="toSelect" type="date" value = "" name="to">
                                </div>
                            </div>
                            <div class = "row">
                                <div class="form-inline">
                                    <button type="submit" class="btn btn-success">Confirm Parameters</button>
                                    <button type="reset" class="btn btn-primary">Reset From</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class = "col-md-12 col-lg-8 col-lg-push-4">
                    <!-- All generated reports on right of page -->
                    <div>
                        <h1>Generated Reports</h1>
                        <table id="reportsTable">
                            <tr>
                                <th width="20%">ID</th>
                                <th width="40%">link</th>
                                <th width = "40%">CSV Generated</th>
                            </tr>
                        </table>
                    </div>
                </div>

            </div>

            <!--<div class="row">-->
                <!--<div class="col-md-12">-->
                    <!--Bottom section-->
                <!--</div>-->
            <!--</div>-->

        </div>



        <div th:replace = "common/footer :: footer"></div>

        <script th:inline="javascript">
            // Use thymeleaf script inlining (<script th:inline="javascript">) to be able to access model attributes in javascript
            /*<![CDATA[*/

            // When the user selects a site, change the channel select options to match that site
            $("#siteSelect").change(function() {
                var siteId = $("#siteSelect").val()
                if (siteId===""){
                    $("#channelSelect").find('option').remove().end();
                } else {
                    populateChannelSelect(siteId)
                }
            });

            // Check all fields filled in before submitted the form
            $("#form").submit(function(event) {
                if ($("#siteSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a site")
                } else if ($("#channelSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a channel")
                } else if ($("#fromSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a date from value")
                } else if ($("#toSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a date to value")
                }
            })

            // If model attributes exist in memory, populate the values on page load
            $(document).ready(function() {
                var siteSearch = /[&?]site=([^&]+)/.exec(location.search)
                var site = siteSearch == null ? "" : siteSearch[1]
                var channelSearch = /[&?]channel=([^&]+)/.exec(location.search)
                var channel = channelSearch == null ? "" : channelSearch[1]
                var fromSearch = /[&?]from=([^&]+)/.exec(location.search)
                var from = fromSearch == null ? "" : fromSearch[1]
                var toSearch = /[&?]to=([^&]+)/.exec(location.search)
                var to = toSearch == null ? "" : toSearch[1]
                if (site != "") {
                    $("#siteSelect").val(site)
                    if (channel !="") {
                        populateChannelSelectAndSelected(site, channel)
                    } else {
                        populateChannelSelect(site)
                    }
                }
                if (from != "") {
                    document.querySelector('#fromSelect').value = from
                }
                if (to != "") {
                    document.querySelector('#toSelect').value = to
                }

                populateReportsSelect()

                populateReportsList()
            })

            function popoulateSiteSelect() {
                $.get("/sites", function(sites) {
                    var option = ''
                    option += '<option value="" selected="selected">--Select a Site--</option>'
                    for (var i=0; i<sites.length;i++) {
                        option += '<option value="' + sites[i].id + '" text="' + sites[i].name + '">' + sites[i].name + '</option>';
                    }
                    $("#siteSelect").find('option').remove().end().append(option);
                })
            }

            function populateChannelSelect(siteId) {
                $.get("/channels/site/"+siteId, function(channels) {
                    var option = ''
                    // Create an empty option and have it selected by default
                    for (var i=0; i<channels.length;i++) {
                        option += '<option value="' + channels[i].id + '" text="' + channels[i].name + '">' + channels[i].name + '</option>';
                    }
                    $("#channelSelect").find('option').remove().end().append(option);
                })
            }

            function populateChannelSelectAndSelected(siteId, channel) {
                $.get("/channels/site/"+siteId, function(channels) {
                    var option = ''
                    for (var i=0; i<channels.length;i++) {
                        option += '<option value="' + channels[i].id + '" text="' + channels[i].name + '">' + channels[i].name + '</option>';
                    }
                    $("#channelSelect").find('option').remove().end().append(option);
                    // Now, still within the asynchronous callback, select the channel that was selected
                    $("#channelSelect").val(channel)
                })
            }

            function populateReportsSelect() {
                $.get("/reports/all", function(reports) {
                    var option = ''
                    for (var i=0; i<reports.length;i++) {
                        option += '<option value="' + reports[i].id + '" text="' + reports[i].id + '">' + reports[i].id + '</option>';
                    }
                    $("#reportSelect").find('option').remove().end().append(option);
                })
            }

            function populateReportsList() {
                $.get("/reports/all", function(reports) {
                    var ids = reports.map(function(report) {
                        return report.id
                    })
                    $.ajax({
                        url: "/reports/raw-analogue-events/generated",
                        type: "POST",
                        contentType:"application/json",
                        data: JSON.stringify(ids),
                        success: function(data) {
                            fillInTable(reports, data)
                        }
                    })


//                    var ul = document.getElementById("reportsList")
//                    if (reports.length > 0) {
//                        $("#reportsList").empty()
//                    }
//                    for (var i=0; i<reports.length;i++) {
//                        var li = document.createElement("li")
//                        li.appendChild(document.createTextNode(reports[i].id))
//                        var a = document.createElement("a")
//                        a.setAttribute("href", "/reports/analogue_results?reportId="+reports[i].id)
//                        a.appendChild(document.createTextNode("View report"))
//                        li.setAttribute("id", reports[i].id)
//                        li.appendChild(a)
//                        ul.appendChild(li)
//                    }
//                    areReportsGenerated(reports)
                })
            }

//            $.document().before(function() {
//                var reports = $.get("/reports/all", function(reports) {
//                    return reports
//                })
//                return reports
//            })

            fillInTable = function(reports, areGenerated) {
                console.log(areGenerated)
                var table = document.getElementById("reportsTable")
                for (var i=0; i<reports.length;i++) {
                    console.log("here")
                    var tr = document.createElement("tr")
                    var td1 = document.createElement("td")
                    var td2 = document.createElement("td")
                    var td3 = document.createElement("td")
                    td1.appendChild(document.createTextNode(reports[i].id))
                    console.log("here2")
                    var a = document.createElement("a")
                    a.setAttribute("href", "/reports/analogue_results?reportId="+reports[i].id)
                    a.appendChild(document.createTextNode("View report"))
                    td2.appendChild(a)
                    var form = document.createElement("form")
                    form.setAttribute("action", "/reports/raw-analogue-events/csv/"+reports[i].id)
                    form.setAttribute("method", "GET")
                    console.log("here3")
                    if (areGenerated[i]) {
                        var button = document.createElement("button")
                        button.setAttribute("id", "csvButton")
                        button.setAttribute("onClick", "submit")
                        button.setAttribute("class", "btn btn-success")
                        button.appendChild(document.createTextNode("Download CSV"))
                        form.appendChild(button)
                    } else {
                        var button = document.createElement("button")
                        button.setAttribute("id", "csvButton")
                        button.setAttribute("onClick", "submit")
                        button.setAttribute("class", "btn btn-danger")
                        button.setAttribute("disabled", "disabled")
                        button.appendChild(document.createTextNode("CSV not generated"))
                        form.appendChild(button)
                    }
                    console.log("here4")
                    td3.appendChild(form)
                    tr.appendChild(td1)
                    tr.appendChild(td2)
                    tr.appendChild(td3)
                    table.appendChild(tr)
                    console.log("here5")
                }
            }

            function areReportsGenerated(ids) {
                return $.ajax({
                    url: "/reports/raw-analogue-events/generated",
                    type: "POST",
                    contentType:"application/json",
                    data: ids
                }).done(function(r) {
                    return r
                }).error(function(e) {
                    alert("Epic Fail!" + e)
                })
            }
            /*]]>*/
        </script>

    </body>

</html>