<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      th:lang-xmllang="en">

    <head>
        <div th:replace = "common/head :: head (title='Raw Analogue Events')"> </div>
        <script type = "text/javascript"
                src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    </head>

    <body>

        <section id="breadcrumbs">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">Raw Analogue Events</li>
            </ol>
        </section>

        <div th:replace = "common/header :: header (title='Raw Analogue Events')"> </div>


        <div class = "row">

            <!-- Form on left of page -->
            <div class="col">
                <form id="form" action="#" action="/reports/raw-analogue-events/parameters" method="post">
                    <div class="container">
                        <div class="row">
                            <label class="col-sm-1">Site:</label>
                            <select id="siteSelect" name="site" class="col-sm-4 col-sm-offset-1">
                                <option value="" selected="selected">--Select a Site--</option>
                                <option th:each="site : ${sites}" th:value="${site.id}" th:text="${site.name}"></option>
                            </select>
                            <label class="col-sm-1">Channel:</label>
                            <select id="channelSelect" name="channel" class="col-sm-4 col-sm-offset-1">
                                <option value="" selected="selected"></option>
                            </select>
                        </div>
                        <div class="row">
                            <label class="col-sm-1">From:</label><input id="fromSelect" class="col-sm-4 col-sm-offset-1" type="date" value = "" name="from">
                            <label class="col-sm-1">To:</label> <input  id="toSelect" class="col-sm-4 col-sm-offset-1" type="date" value = "" name="to">
                        </div>
                        <div class="row">
                            <div class="col-sm-6 form-group">
                                <button type="submit" class="btn btn-success">Confirm Parameters</button>
                            </div>
                            <div class="col-sm-6 text-right form-group">
                                <button type="reset" class="btn btn-primary">Reset From</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- All generated reports on right of page -->
            <div class="col">
                <h1>Generated Reports</h1>
                <form action="#" action="/reports/analogue_results" method="get">
                    <select id="reportSelect" name="reportId" class="col-sm-4 col-sm-offset-1">
                        <option value="" selected="selected">--Select a Report--</option>
                        <option th:each="site : ${reports}" th:value="${report.id}" th:text="${report.id}"></option>
                    </select>
                    <div>
                        <button type="submit" class="btn btn-primary">View Report</button>
                    </div>
                </form>
            </div>

        </div>


        <div th:replace = "common/footer :: footer"></div>

        <script th:inline="javascript">
            // When the user selects a site, change the channel select options to match that site
            $("#siteSelect").change(function() {
                var siteId = $("#siteSelect").val()
                if (siteId===""){
                    $("#channelSelect").find('option').remove().end();
                } else {
                    populateChannelSelect(siteId)
                }
            });

            // Check all fields filled in before submitted the form
            $("#form").submit(function(event) {
                if ($("#siteSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a site")
                } else if ($("#channelSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a channel")
                } else if ($("#fromSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a date from value")
                } else if ($("#toSelect").val()==="") {
                    event.preventDefault();
                    alert("Please select a date to value")
                }
            })

            // Use thymeleaf script inlining (<script th:inline="javascript">) to be able to access model attributes in javascript
            /*<![CDATA[*/
            // If model attributes exist in memory, populate the values on page load
            $(document).ready(function() {
                var siteSearch = /[&?]site=([^&]+)/.exec(location.search)
                var site = siteSearch == null ? "" : siteSearch[1]
                var channelSearch = /[&?]channel=([^&]+)/.exec(location.search)
                var channel = channelSearch == null ? "" : channelSearch[1]
                var fromSearch = /[&?]from=([^&]+)/.exec(location.search)
                var from = fromSearch == null ? "" : fromSearch[1]
                var toSearch = /[&?]to=([^&]+)/.exec(location.search)
                var to = toSearch == null ? "" : toSearch[1]
                if (site != "") {
                    $("#siteSelect").val(site)
                    if (channel !="") {
                        populateChannelSelectAndSelected(site, channel)
                    } else {
                        populateChannelSelect(site)
                    }
                }
                if (from != "") {
                    document.querySelector('#fromSelect').value = from
                }
                if (to != "") {
                    document.querySelector('#toSelect').value = to
                }

              populateReportsSelect()
            })

            function popoulateSiteSelect() {
                $.get("/sites", function(sites) {
                    var option = ''
                    option += '<option value="" selected="selected">--Select a Site--</option>'
                    for (var i=0; i<sites.length;i++) {
                        option += '<option value="' + sites[i].id + '" text="' + sites[i].name + '">' + sites[i].name + '</option>';
                    }
                    $("#siteSelect").find('option').remove().end().append(option);
                })
            }

            function populateChannelSelect(siteId) {
                $.get("/channels/site/"+siteId, function(channels) {
                    var option = ''
                    // Create an empty option and have it selected by default
                    for (var i=0; i<channels.length;i++) {
                        option += '<option value="' + channels[i].id + '" text="' + channels[i].name + '">' + channels[i].name + '</option>';
                    }
                    $("#channelSelect").find('option').remove().end().append(option);
                })
            }

            function populateChannelSelectAndSelected(siteId, channel) {
                $.get("/channels/site/"+siteId, function(channels) {
                    var option = ''
                    for (var i=0; i<channels.length;i++) {
                        option += '<option value="' + channels[i].id + '" text="' + channels[i].name + '">' + channels[i].name + '</option>';
                    }
                    $("#channelSelect").find('option').remove().end().append(option);
                    // Now, still within the asynchronous callback, select the channel that was selected
                    $("#channelSelect").val(channel)
                })
            }

            function populateReportsSelect() {
                $.get("/reports/all", function(reports) {
                    var option = ''
                    for (var i=0; i<reports.length;i++) {
                        option += '<option value="' + reports[i].id + '" text="' + reports[i].id + '">' + reports[i].id + '</option>';
                    }
                    $("#reportSelect").find('option').remove().end().append(option);
                })
            }
            /*]]>*/
        </script>

    </body>

</html>